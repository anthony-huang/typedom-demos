<!DOCTYPE html>
<head>

<link href="demo.css" rel="stylesheet" type="text/css">

</head>
<body>

<div id="footer">
    <div id="fps">--fps</div>
    <button id="start" type="button" value="test" style="line-height:150%;"> START </button>
</div>
<div id="container"></div>

<script src="https://code.jquery.com/jquery-2.1.3.min.js" type="text/javascript"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.4/plugins/CSSPlugin.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.4/TweenLite.min.js"></script>

<script>

var fpsElement = document.getElementById("fps");
var button = document.getElementById("start");
var container = document.getElementById("container");
var inProgress = false;
var durationMicros = 1200; // ms
var dots = [];
var dotQtyInput = 100;

var Dot = function(element, x, y, targetX, targetY, delay) {
  this.element = element;
  this.x = x;
  this.y = y;
  this.startX = x;
  this.startY = y;
  this.addX = targetX - x;
  this.addY = targetY - y;
  this.delay = delay;
  this.startTime = 0;
}

Dot.initialSize = 1; // px
Dot.finalSize = 32; // px

Dot.prototype.update = function(now) {
  if (!this.startTime) {
    this.startTime = now;
  }
  var elapsed = now - this.startTime;
  if (elapsed < this.delay) { return; }
  var progress = (elapsed - this.delay) / durationMicros;
  this.x = this.startX + this.addX * progress;
  this.y = this.startY + this.addY * progress;
  var size = Dot.finalSize * progress;
  this.element.styleMap.set('left', new CSSSimpleLength(this.x, 'px'));
  this.element.styleMap.set('top', new CSSSimpleLength(this.y, 'px'));
  this.element.styleMap.set('width', new CSSSimpleLength(size, 'px'));
  this.element.styleMap.set('height', new CSSSimpleLength(size, 'px'));
}

Dot.prototype.reset = function(now) {
  this.x = this.startX;
  this.y = this.startY;
  this.startTime = now;
  this.element.styleMap.set('left', new CSSSimpleLength(this.x, 'px'));
  this.element.styleMap.set('right', new CSSSimpleLength(this.y, 'px'));
  this.element.styleMap.set('width', new CSSSimpleLength(Dot.initialSize, 'px'));
  this.element.styleMap.set('height', new CSSSimpleLength(Dot.initialSize, 'px'));
}

Dot.prototype.done = function(now) {
  return ((now - this.startTime - this.delay) > durationMicros);
}

animationFrame = 0;
typedom_demo = {
  createDot:function(element, centerX, centerY, radius) {
    var angle = Math.random() * Math.PI * 2;
    return new Dot(
    element,
    centerX,
    centerY,
    Math.cos(angle) * radius + centerX,
    Math.sin(angle) * radius + centerY,
    Math.random() * durationMicros);
  },
  start:function(dots) {
    function updateDots(dots, timestamp) {
      for (var i = 0; i < dots.length; ++i) {
        if (dots[i].done(timestamp)) {
          dots[i].reset(timestamp);
          } else {
          dots[i].update(timestamp);
        }
      }
      updateFPS(timestamp);
      animationFrame = window.requestAnimationFrame(updateDots.bind(null, dots));
    }
    animationFrame = window.requestAnimationFrame(updateDots.bind(null, dots));
  },
  stop:function(dot) {
    if (animationFrame) {
      window.cancelAnimationFrame(animationFrame);
      animationFrame = 0;
    }
  },
};

function toggle() {
  if (inProgress) {
    button.innerHTML = " START ";
    for (var i = 0; i < dots.length; i++) {
      typedom_demo.stop();
    }
  } else {
    if (!dots.length) {
      var centerX = jQuery(window).width() / 2;
      var centerY = (jQuery(window).height() / 2) - 30;
      var startingCSS = "position:absolute; left:" + centerX + "px; top:" + centerY + "px; width:1px; height:1px;"; 
      var radius = Math.sqrt(centerX * centerX + centerY * centerY);
      createDots(startingCSS, centerX, centerY, radius);
    }
    typedom_demo.start(dots);

    frames = 0;
    fpsStartTime = performance.now();

    button.innerHTML = " STOP ";
  }
  inProgress = !inProgress;
}

function createDots(startingCSS, centerX, centerY, radius) {
  var i = dotQtyInput, dot;
  rawDots = [];
  while (--i > -1) {
    dot = document.createElement("img");
    dot.src = "https://greensock.com/js/img/dot.png";
    dot.width = 1;
    dot.height = 1;
    dot.id = "dot" + i;
    dot.style.cssText = startingCSS;
    container.appendChild(dot);
    rawDots.push(dot);
    dots.push(typedom_demo.createDot(dot, centerX, centerY, radius));
  }
}

function updateFPS(now) {
  frames++;
  var elapsed = now - fpsStartTime;
  if (elapsed > 1000) {
    fpsElement.innerHTML = Number(frames / elapsed * 1000 ).toFixed(1) + " fps";
  }
}

document.getElementById("start").addEventListener("click", toggle);

</script>

</body>
